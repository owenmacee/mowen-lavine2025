---
title: "CAV spatial merged analysis"
author: "Macee Owen"
output: html_document
---

# Load relevant libraries
```{r}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(hdf5r)
library(harmony)
library(SPOTlight)
library(SeuratData)
library(SeuratDisk)
library(enrichplot)
library(enrichR)
library(Matrix)
library(data.table)
library(gt)
library(igraph)
library(RColorBrewer)
library(VennDiagram)
library(viridis)
library(spacexr)
```

# Load merged spatial object
```{r}
ICAV.merge <- readRDS("./ICAV.merge.rds")
```

# Cluster and annotate merged spatial object
```{r}
DefaultAssay(ICAV.merge) <- "SCT"
VariableFeatures(ICAV.merge) <- c(VariableFeatures(CAV1), VariableFeatures(CAV2), VariableFeatures(CAV3), VariableFeatures(CAV4))
ICAV.merge <- SCTransform(ICAV.merge, assay = "Spatial", verbose = TRUE, conserve.memory = TRUE)
ICAV.merge <- RunPCA(ICAV.merge, assay = "SCT", verbose = FALSE, features = VariableFeatures(object = ICAV.merge))
ICAV.merge <- RunHarmony(object = ICAV.merge, assay.use = "SCT", reduction = "pca", dims.use = 1:40, reduction.save = "harmony", group.by.vars = "sample")
ICAV.merge <- FindNeighbors(ICAV.merge, reduction = "pca", dims = 1:40)
ICAV.merge <- FindClusters(ICAV.merge, verbose = FALSE, resolution = c(0.1,0.2,0.3,0.4,0.5,0.6))
ICAV.merge <- RunUMAP(ICAV.merge, reduction = "pca", dims = 1:40, return.model = TRUE)

saveRDS(ICAV.merge, "./ICAV.merge clustered.rds")
```

# Plot UMAPs of object and spatial clusters
```{r}
# Plot UMAP of merged spatial object with numbered clusters
png(filename="./ICAV.mergeumap0.5.png", width=35, height=40, units="cm", res=300)
DimPlot(ICAV.merge, group.by = "SCT_snn_res.0.5", label = TRUE)
dev.off()

# Plot clusters of merged object in space with numbered clusters
Idents(ICAV.merge) <- "SCT_snn_res.0.5"
png(filename="./ICAV.mergespatialdimplot.png", width=40, height=40, units="cm", res=300)
SpatialDimPlot(ICAV.merge, label = TRUE, label.size = 3)
dev.off()
```

# Generate marker list for desired resolution
```{r}
# Identify and annotate clusters
DefaultAssay(ICAV.merge) <- "SCT"
Idents(ICAV.merge) <- "SCT_snn_res.0.5"
ICAV.merge <- PrepSCTFindMarkers(ICAV.merge)
ICAV.merge.rnamarkers <- FindAllMarkers(ICAV.merge, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.25)
write.csv(ICAV.merge.rnamarkers, file ="./ICAVmergemarkers.csv", quote = FALSE)
```
```{r}
# Annotate spatial niches based on marker list at 0.1 resolution
fun <- function(x) {
        if (x == "0") {"Immune"}
        else if (x == "1") {"Fibroblast"}
        else if (x == "2") {"Cardiomyocyte"}
        else if (x == "3") {"Glia"}
        else if (x == "4") {"Fibroblast"}
        else if (x == "5") {"SMC"}
        else if (x == "6") {"SMC"}
        else if (x == "7") {"Adipocyte"}
}

ICAV.merge$annotations <- mapply(fun, ICAV.merge$SCT_snn_res.0.1)
```

# Plot UMAPs with cell type annotations
```{r}
png(filename="./ICAV.mergeumap0.5.png", width=35, height=40, units="cm", res=300)
DimPlot(ICAV.merge, group.by = "annotations", label = TRUE)
dev.off()
```

# Plot stacked bar graph with cell type proportions
```{r}
png(filename="./ICAVmergestack.png", width=20, height=25, units="cm", res=300)
ggplot(ICAV.merge@meta.data, aes(x=sample, fill=annotations)) + 
  geom_bar(position = "fill") + theme_linedraw() + 
  theme(axis.text.x = element_text(size=24), axis.title.y = element_text(size=24, face="bold")) + 
  theme(axis.line = element_line(colour = "black"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) 
dev.off()
```

# Spatial plot with annotations
```{r}
# With legend
png(filename="./spatialdimplotmerge.png", width=20, height=20, units="cm", res=300)
SpatialDimPlot(ICAV.merge, group.by = "annotations") +
  theme(legend.position = "right") +
  labs(title = "Spatial DimPlot with Annotated Clusters")
dev.off()

# Save merged spatial object with annotations
```{r}
saveRDS(ICAV.merge, "ICAV.merge with annotations.rds")
```

# Feature plots
```{r}
# Spatial feature plot overlaid on H&E
SpatialFeaturePlot(ICAV.merge, features = c("SPP1"), alpha=c(0.1,1)) + 
  theme(legend.text = element_text(size = 0), 
        legend.title = element_text(size = 20), 
        legend.key.size = unit(1, "cm"))
```

